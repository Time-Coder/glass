# Exponential Soft Shadow Mapping

# Abstract
In this paper we present an image-based algorithm to render visually plausible anti-aliased soft shadows in real time. Our technique employs a new shadow pre-filtering method based on an extended exponential shadow mapping theory. The algorithm achieves faithful contact shadows by adopting an optimal approximation to exponential shadow reconstruction function. Benefiting from a novel overflow free summed area table tile grid data structure, numerical stability is guaranteed and error filtering response is avoided. By integrating an adaptive anisotropic filtering method, the proposed algorithm can produce high quality smooth shadows both in large penumbra areas and in high frequency sharp transitions, meanwhile guarantee cheap memory consumption and high performance.

# Introduction
Soft shadow is an important component in realistic image synthesis. Real time applications, such as 3D computer games and virtual reality, usually require high quality soft shadows. However, rendering high quality soft shadows efficiently is still a challenging problem. The soft shadow value for a screen pixel is the visibility of the extended light source viewed from the point in the scene corresponding to the pixel. This visibility test is computationally intensive. Image-based approach based on shadow map and its extensions scale well with the scene complexity, which gradually become the main stream solution in industry. Among them, Percentage Closer Filtering (PCF) is the most prevalent one owing to its simplicity and efficiency. PCF smoothes the shadow edges by filtering the binary shadow test results in a given kernel. As a result, it can produce soft transition along hard shadow boundary. Recently, the extension of PCF, Percentage-Closer Soft Shadows (PCSS), is widely adopted to generate visually plausible soft shadows efficiently, and can be easily integrated into existing rendering systems. PCSS assumes that the occulders/receivers are planar and parallel to the light source. For each pixel to be rendered, PCSS first computes the average blocker depth by averaging the depth values of the texels in a searching kernel which are smaller than the depth of the current pixel in light space. Then the penumbra size is estimated by the average blocker depth. Finally, PCF is applied by looping all the sampling points in the penumbra.

As the complexity of both the average blocker depth evaluation and soft shadowing steps is proportional to the penumbra size, rendering efficiency measured by frame rates in general may drop dramatically due to massive texture samples when the light source is large. Furthermore, image based approaches like PCSS suffer from severe aliasing problems. There are mainly two kinds of aliasing phenomenon. When the shadow map resolution is inadequate, these algorithms tend to produce jagged edges. When the screen resolution is low, Moir√© patterns can appear on high frequency shadows. We denote the two kinds of soft shadow aliasing as "shadow-map aliasing" and "screen-space aliasing" respectively in this paper.

Exponential Shadow Mapping (ESM) is proposed to perform hard shadow anti-aliasing efficiently, which adopts the exponential function to approximate the binary shadow test function and applied pre-filtering to gain significant speed up. The ESM theory is simple and easy to implement. Its cheap memory cost and computation overhead guarantees its high performance. Unfortunately, the exponential function is a "single-bounded" function. It diverges exponentially on the left side, thus leads to incorrectly-lit artifacts due to the "non-planarity" problem. The definition of "single-bounded" function and "non-planarity" problem is proposed and investigated by Yang et al. The former indicates a function which only bound one side of the shadow test function and the latter indicates the problem that adopting a "single-bounded" function as the pre-filtering shadow function may produce incorrect results for large partially shadowed kernels. Moreover, few research focuses on how to determine the value of ESM function parameter c, which may affect the steepness of the approximated function. An inappropriate c may lead to the loss of contact shadow artifact. Furthermore, extending ESM theory to soft shadow framework is still an open problem.

To generate penumbra with arbitrary width in constant time, the summed-area table(SAT) is widely adopted as a pre-filtering function due to its satisfied filtering quality and efficiency. However, SAT is only suitable for simple scenes rendered by a low resolution shadow map, because its construction overhead and precision loss increase dramatically when the shadow map resolution becomes large. In order to maintain performance and avoid error shadow test results caused by precision instability of SAT, current pre-filtered soft shadow techniques can only adopt a low resolution shadow map. Hence the "shadow-map aliasing" may occur. Furthermore, SAT only supports rectangular filter kernels, which is incompatible with anisotropic filtering. Consequently, the "screenspace aliasing" is still a problem to be solved.

In this paper, We present Exponential Soft Shadow Mapping (ESSM), a PCSS based pre-filtering soft shadow technique, which employs the exponential function as shadow reconstruction function, for the sake of high quality pre-filtering and cheap space/time overhead. The main contributions of the proposed algorithm are:
1. A new formula based on ESM theory is given to estimate the average blocker depth in PCSS framework, thus ESM theory is extended to soft shadow rendering.
2. Faithful contact shadow is obtained by adopting the optimal ESM function parameter and effective depth range in light space.
3. Incorrectly-lit artifacts caused by non-planarity problem are alleviated by micro-subdivision.
4. An adaptive overflow free SAT tile grid data structure for pre-filtering is designed, which can significantly reduce both the SAT precision loss and SAT building computation cost. Thereby it overcomes the resolution restriction of pre-filtering soft shadow techniques when using SAT.
5. By introducing an adaptive approximation scheme to an anti-aliased ellipsoid soft shadow filtering kernel, efficient anisotropic shadow filtering is applied on SAT. The experimental results show that the proposed algorithm can render both simple game-like scenes at very high frame rates and complex large scale scenes efficiently in real-time. The produced visually plausible soft shadows are smooth and well anti-aliased.